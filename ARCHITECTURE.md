# TTS-BOT æ¶æ„æ–‡æ¡£

## æ¦‚è¿°

TTS-BOT æ˜¯ä¸€ä¸ªå¤š Bot Telegram ç³»ç»Ÿï¼Œæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ–‡å­—/è¯­éŸ³/å›¾ç‰‡ï¼‰ï¼Œè½¬å‘ç»™ AI CLIï¼ˆkiro-cli ç­‰ï¼‰ï¼Œæ•è·å›å¤å‘å› Telegramï¼Œæ”¯æŒ TTS è¯­éŸ³åˆæˆã€‚é€šè¿‡é…ç½®æ–‡ä»¶åŠ¨æ€ç®¡ç†å¤šä¸ª Bot å®ä¾‹ã€‚

---

## ç³»ç»Ÿæ¶æ„å›¾

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Telegram    â”‚
                         â”‚   ç”¨æˆ·æ¶ˆæ¯     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Cloudflare Tunnel    â”‚
                    â”‚   (âŒ ç»ä¸èƒ½ kill)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Docker å®¹å™¨ (tts-bot)                       â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              supervisor.py (ä¸»è¿›ç¨‹)                      â”‚  â”‚
â”‚  â”‚  â€¢ æ¯ 5s ç›‘å¬ bots.conf å˜åŒ–                            â”‚  â”‚
â”‚  â”‚  â€¢ è‡ªåŠ¨å¢åˆ  bot / ttyd è¿›ç¨‹                             â”‚  â”‚
â”‚  â”‚  â€¢ å´©æºƒè‡ªåŠ¨é‡å¯ï¼Œç«¯å£è‡ªåŠ¨å›æ”¶                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                           â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  bot_api.py :15001      â”‚  â”‚  kiro_handler.py         â”‚  â”‚
â”‚  â”‚  å…±äº« HTTP API           â”‚  â”‚  å¤šçº¿ç¨‹ tmux æ•è·å™¨       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                           â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Redis (tts:session_map)                    â”‚  â”‚
â”‚  â”‚  kiro_master:0 â†’ {kiro-bot, :15001, token, chat_id}   â”‚  â”‚
â”‚  â”‚  kimi:0        â†’ {kimi-bot, :15001, token, chat_id}   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Bot è¿›ç¨‹ (æ¯ä¸ª token ä¸€ä¸ª)                             â”‚  â”‚
â”‚  â”‚  bot-1: kiro-bot â†’ tmux session kiro_master            â”‚  â”‚
â”‚  â”‚  bot-2: kimi-bot â†’ tmux session kimi                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ttyd è¿›ç¨‹ (æ¯ä¸ª session ä¸€ä¸ª, åªè¯» Web ç»ˆç«¯)           â”‚  â”‚
â”‚  â”‚  :7680 /kiro_master/   :7681 /kimi/                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  nginx :12345 (åŠ¨æ€è·¯ç”±)                                â”‚  â”‚
â”‚  â”‚  /<session_name>/ â†’ å¯¹åº” ttyd ç«¯å£                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   å®¿ä¸»æœº tmux sessions
   â”œâ”€â”€ kiro_master:0  (kiro-cli)
   â””â”€â”€ kimi:0         (kimi-cli)
```

---

## æ¶ˆæ¯æµè½¬è¯¦è§£

### 1. æ–‡å­—æ¶ˆæ¯æµè½¬

```
ç”¨æˆ·åœ¨ Telegram å‘é€æ–‡å­—
        â”‚
        â–¼
â”Œâ”€ bot.py handle_text_message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  â‘  åˆ¤æ–­æ˜¯å¦ä¸º t/n/y å†³ç­–å­—ç¬¦                              â”‚
â”‚     â†’ æ˜¯: tmux.send_keys(char) ç›´æ¥å‘é€ï¼Œæµç¨‹ç»“æŸ          â”‚
â”‚                                                          â”‚
â”‚  â‘¡ åˆ¤æ–­æ˜¯å¦ä¸º /å‘½ä»¤                                       â”‚
â”‚     â†’ æ˜¯: handle_special_command() å¤„ç†ï¼Œæµç¨‹ç»“æŸ          â”‚
â”‚                                                          â”‚
â”‚  â‘¢ æ™®é€šæ–‡å­—:                                              â”‚
â”‚     â†’ tmux.send_text(text, "kimi:master")  å‘åˆ° kimi     â”‚
â”‚     â†’ sleep(1.0)                                         â”‚
â”‚     â†’ tmux.send_keys("ENTER", "kimi:master")             â”‚
â”‚     â†’ tmux.send_text(text, config.win_id)  å‘åˆ° kiro     â”‚
â”‚     â†’ sleep(tmux_send_delay)                             â”‚
â”‚     â†’ tmux.send_keys("ENTER", config.win_id)             â”‚
â”‚                                                          â”‚
â”‚  â‘£ å†™å…¥ active_chat_id æ–‡ä»¶                               â”‚
â”‚  â‘¤ å‘é€ "ğŸ’­ Thinking..." ACK æ¶ˆæ¯                        â”‚
â”‚  â‘¥ å†™å…¥ ack_message_id æ–‡ä»¶                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼  (AI CLI åœ¨ tmux ä¸­å¤„ç†...)
        â”‚
â”Œâ”€ kiro_handler.py (æ¯ 2s è½®è¯¢) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  â‘  å¤šçº¿ç¨‹å¹¶å‘ tmux capture-pane æ‰€æœ‰ session              â”‚
â”‚                                                          â”‚
â”‚  â‘¡ æ£€æµ‹å†…å®¹å˜åŒ– (content_changed)                         â”‚
â”‚     â†’ æ— å˜åŒ–: è·³è¿‡                                        â”‚
â”‚                                                          â”‚
â”‚  â‘¢ æ£€æµ‹æ˜¯å¦ç©ºé—² (is_idle)                                 â”‚
â”‚     åˆ¤æ–­æ ‡å¿—: "> What would you like to do next?"         â”‚
â”‚                                                          â”‚
â”‚  â‘£ éç©ºé—² (AI æ­£åœ¨å·¥ä½œ):                                  â”‚
â”‚     â†’ æ£€æµ‹ [y/n/t] æç¤º â†’ è‡ªåŠ¨å‘é€ 't' æˆæƒ               â”‚
â”‚     â†’ æ ‡è®° was_busy = True                               â”‚
â”‚     â†’ ä¿å­˜ busy_start å¿«ç…§ (é¦–æ¬¡è¿›å…¥ busy æ—¶)             â”‚
â”‚     â†’ æ›´æ–° last å¿«ç…§                                      â”‚
â”‚                                                          â”‚
â”‚  â‘¤ ç©ºé—² + was_busy (AI åˆšå®Œæˆå›å¤):                       â”‚
â”‚     â†’ extract_new_reply(busy_start, current)             â”‚
â”‚       - å¯¹æ¯” busy å‰åå†…å®¹å·®å¼‚                             â”‚
â”‚       - è¿‡æ»¤å·¥å…·è¾“å‡ºè¡Œ (I will run, Purpose:, etc.)       â”‚
â”‚       - MD5 å»é‡é˜²æ­¢é‡å¤å‘é€                               â”‚
â”‚     â†’ è·å– chat_id (Redis æˆ– active_chat_id æ–‡ä»¶)         â”‚
â”‚     â†’ POST /reply åˆ° bot_api                             â”‚
â”‚       (3 æ¬¡é‡è¯•, æŒ‡æ•°é€€é¿, 10s è¶…æ—¶)                       â”‚
â”‚     â†’ æ ‡è®° was_busy = False                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€ bot_api.py POST /reply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  â‘  get_bot_by_name(bot_name)                             â”‚
â”‚     â†’ ä» Redis session_map æŸ¥æ‰¾å¯¹åº” bot_token             â”‚
â”‚     â†’ åˆ›å»º Bot å®ä¾‹ (æœ‰ç¼“å­˜)                              â”‚
â”‚                                                          â”‚
â”‚  â‘¡ split_reply(text)                                     â”‚
â”‚     â†’ çŸ­å›å¤ (â‰¤200å­—): summary=å…¨æ–‡, detail=None          â”‚
â”‚     â†’ é•¿å›å¤ (>200å­—): summary=ç¬¬ä¸€å¥, detail=å…¨æ–‡         â”‚
â”‚                                                          â”‚
â”‚  â‘¢ é•¿å›å¤:                                                â”‚
â”‚     â†’ md_to_tg_html(å…¨æ–‡) â†’ Telegram HTML                 â”‚
â”‚     â†’ send_message(çº¯æ–‡å­—)                                â”‚
â”‚                                                          â”‚
â”‚  â‘£ çŸ­å›å¤:                                                â”‚
â”‚     â†’ strip_emoji(summary) â†’ å»æ‰ emoji                  â”‚
â”‚     â†’ POST http://localhost:15002/tts â†’ ç”Ÿæˆ mp3          â”‚
â”‚     â†’ send_voice(è¯­éŸ³ + HTML caption)                     â”‚
â”‚     â†’ TTS å¤±è´¥æ—¶ fallback åˆ°çº¯æ–‡å­—                        â”‚
â”‚                                                          â”‚
â”‚  â‘¤ åˆ é™¤ ACK æ¶ˆæ¯ (è¯»å– ack_message_id æ–‡ä»¶)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   ç”¨æˆ·åœ¨ Telegram æ”¶åˆ°å›å¤
   çŸ­å›å¤: ğŸ”Š è¯­éŸ³ + æ–‡å­— caption
   é•¿å›å¤: ğŸ“ çº¯æ–‡å­— (Markdownâ†’HTML)
```

### 2. è¯­éŸ³æ¶ˆæ¯æµè½¬

```
ç”¨æˆ·åœ¨ Telegram å‘é€è¯­éŸ³
        â”‚
        â–¼
â”Œâ”€ bot.py handle_voice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  â‘  å‘é€ "ğŸ§ è¯†åˆ«ä¸­..." ACK                               â”‚
â”‚  â‘¡ ä¸‹è½½ .ogg è¯­éŸ³æ–‡ä»¶åˆ° /tmp/voice_{id}.ogg              â”‚
â”‚  â‘¢ POST åˆ° STT API (:15003) è¯†åˆ«                         â”‚
â”‚     â†’ Google Speech-to-Text                              â”‚
â”‚  â‘£ è¯†åˆ«å¤±è´¥ â†’ ç¼–è¾‘ ACK ä¸º "âŒ è¯†åˆ«å¤±è´¥"                    â”‚
â”‚  â‘¤ è¯†åˆ«æˆåŠŸ â†’ ç¼–è¾‘ ACK ä¸º "ğŸ¤ {è¯†åˆ«æ–‡å­—}"                 â”‚
â”‚  â‘¥ tmux.send_text(text, config.win_id)                   â”‚
â”‚     â†’ åŒæ–‡å­—æ¶ˆæ¯æµç¨‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼  (åç»­åŒæ–‡å­—æ¶ˆæ¯: handler æ•è· â†’ /reply â†’ å‘å›)
```

### 3. å›¾ç‰‡æ¶ˆæ¯æµè½¬

```
ç”¨æˆ·åœ¨ Telegram å‘é€å›¾ç‰‡
        â”‚
        â–¼
â”Œâ”€ bot.py handle_photo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                          â”‚
â”‚  â‘  å‘é€ "ğŸ” è¯†åˆ«ä¸­..." ACK                               â”‚
â”‚  â‘¡ ä¸‹è½½æœ€å¤§å°ºå¯¸å›¾ç‰‡åˆ° /tmp/photo_{id}.png                 â”‚
â”‚  â‘¢ OCR è¯†åˆ« (ä¸‰çº§ fallback):                              â”‚
â”‚     1st: Gemini API (æœ€å‡†)                                â”‚
â”‚     2nd: OCR.space API                                   â”‚
â”‚     3rd: EasyOCR (:15010)                                â”‚
â”‚  â‘£ è¯†åˆ«å¤±è´¥ â†’ "âŒ æœªè¯†åˆ«åˆ°æ–‡å­—"                            â”‚
â”‚  â‘¤ è¯†åˆ«æˆåŠŸ â†’ ç¼–è¾‘ ACK ä¸º "ğŸ“· {è¯†åˆ«æ–‡å­—}"                 â”‚
â”‚  â‘¥ åŒæ—¶å‘åˆ° kimi + kiro ä¸¤ä¸ª tmux session                 â”‚
â”‚     â†’ åŒæ–‡å­—æ¶ˆæ¯æµç¨‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼  (åç»­åŒæ–‡å­—æ¶ˆæ¯: handler æ•è· â†’ /reply â†’ å‘å›)
```

### 4. å®Œæ•´æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Telegram â”‚â”€â”€â”€â–¶â”‚  bot.py â”‚â”€â”€â”€â–¶â”‚  tmux    â”‚â”€â”€â”€â–¶â”‚ handler  â”‚â”€â”€â”€â–¶â”‚ bot_api â”‚
â”‚  ç”¨æˆ·    â”‚    â”‚ æ¥æ”¶æ¶ˆæ¯ â”‚    â”‚ AI CLI   â”‚    â”‚ æ•è·å›å¤  â”‚    â”‚ å‘é€å›å¤ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â–²                                                             â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Telegram â”‚â—€â”€â”€â”€â”‚ TTS è¯­éŸ³  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        æ”¶åˆ°å›å¤     â”‚  API     â”‚    â”‚ :15002   â”‚  çŸ­å›å¤èµ° TTS
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. supervisor.py (ä¸»è¿›ç¨‹)
- è§£æ `bots.conf` é…ç½®æ–‡ä»¶
- æ¯ 5 ç§’æ£€æµ‹é…ç½®å˜åŒ–ï¼Œè‡ªåŠ¨å¢åˆ  bot
- ä¸ºæ¯ä¸ª bot åˆ›å»º tmux session + ttyd ç»ˆç«¯
- è¿›ç¨‹å´©æºƒè‡ªåŠ¨é‡å¯ï¼Œç«¯å£è‡ªåŠ¨åˆ†é…/å›æ”¶
- é…ç½®æ–‡ä»¶åˆ é™¤/æ¸…ç©ºä¸å½±å“å·²è¿è¡Œè¿›ç¨‹
- è‡ªåŠ¨ç”Ÿæˆ nginx é…ç½®å¹¶ reload

### 2. bot.py (Telegram Bot)
- æ¥æ”¶ Telegram æ¶ˆæ¯ (long polling)
- æ–‡å­—: ç›´æ¥ tmux send-keys
- è¯­éŸ³: ä¸‹è½½ â†’ STT(:15003) â†’ æ–‡å­— â†’ tmux
- å›¾ç‰‡: ä¸‹è½½ â†’ OCR(Gemini/OCR.space/EasyOCR) â†’ æ–‡å­— â†’ tmux
- t/n/y å•å­—ç¬¦: ç›´æ¥ send-keys ä¸èµ° AI
- /start: æ˜¾ç¤º Mini App ç»ˆç«¯æŒ‰é’®
- å¯åŠ¨æ—¶æ³¨å†Œåˆ° Redis session_map

### 3. kiro_handler.py (å›å¤æ•è·å™¨)
- å¤šçº¿ç¨‹å¹¶å‘ capture-pane æ‰€æœ‰ session (ThreadPoolExecutor)
- ä» Redis session_map è¯»å–ç›‘æ§åˆ—è¡¨ï¼Œæ¯ 60s åˆ·æ–°
- ç©ºé—²æ£€æµ‹: `> What would you like to do next?`
- busyâ†’idle è½¬æ¢æ—¶æå–å›å¤ (busy_start vs current å¯¹æ¯”)
- è¿‡æ»¤å·¥å…·è¾“å‡ºè¡Œï¼ŒMD5 å»é‡
- è‡ªåŠ¨æ£€æµ‹ [y/n/t] å¹¶å‘é€ 't' æˆæƒ
- 3 æ¬¡é‡è¯• + æŒ‡æ•°é€€é¿å‘é€ /reply

### 4. bot_api.py (HTTP API :15001)
- `POST /reply`: æŒ‰ bot_name è·¯ç”±åˆ°å¯¹åº” Bot å®ä¾‹
- çŸ­å›å¤(â‰¤200å­—): TTS(:15002) è¯­éŸ³ + caption
- é•¿å›å¤(>200å­—): Markdownâ†’Telegram HTML çº¯æ–‡å­—
- Bot å®ä¾‹ç¼“å­˜ï¼Œä» Redis è·å– token
- è‡ªåŠ¨åˆ é™¤ ACK æ¶ˆæ¯

### 5. session_map.py (Redis æ˜ å°„)
- `tts:session_map` Hash: `{win_id â†’ {bot_name, api_url, chat_id, bot_token}}`
- bot å¯åŠ¨æ—¶æ³¨å†Œï¼Œhandler è¯»å–

---

## é…ç½®

### bots.conf
```
# æ ¼å¼: token,tmux_session(å¯é€‰)
8581547902:AAEcXXXXX              # è‡ªåŠ¨ç”¨ bot username ä½œ session
9912345678:BBBxXXXXX,kimi_master  # æŒ‡å®š session name
```

### ç¯å¢ƒå˜é‡
| å˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| BOT_TOKEN | (å¿…å¡«) | Telegram Bot Token |
| BOT_NAME | kiro-bot | Bot æ ‡è¯†å |
| TMUX_SESSION | (ç©º) | tmux ä¼šè¯å |
| API_PORT | 15001 | Bot API ç«¯å£ |
| REDIS_URL | redis://localhost:6379/0 | Redis |
| TTS_VOICE | zh-CN-XiaoxiaoNeural | TTS è¯­éŸ³ |
| TTS_SHORT_LIMIT | 200 | çŸ­å›å¤é˜ˆå€¼(å­—) |
| OWNER_ID | - | ç®¡ç†å‘˜ Telegram ID |

---

## å¯åŠ¨æ¨¡å¼

### å• Bot æ¨¡å¼
`bots.conf` ä¸ºç©º â†’ ç”¨ç¯å¢ƒå˜é‡å¯åŠ¨å•ä¸ª bot

### å¤š Bot æ¨¡å¼ (Supervisor)
`bots.conf` æœ‰é…ç½® â†’ supervisor æ¥ç®¡:
1. è§£æé…ç½® â†’ getMe è·å– bot name
2. åˆ›å»º tmux session â†’ å¯åŠ¨ ttyd â†’ å¯åŠ¨ bot
3. å¯åŠ¨å…±äº« bot_api + handler
4. æŒç»­ç›‘æ§é…ç½®å˜åŒ–å’Œè¿›ç¨‹å¥åº·

---

## åŠ¨æ€ç®¡ç†

```bash
# æ·»åŠ  Bot (5s å†…è‡ªåŠ¨ç”Ÿæ•ˆ)
echo "NEW_TOKEN,session_name" >> bots.conf

# åˆ é™¤ Bot (5s å†…è‡ªåŠ¨åœæ­¢)
# ä» bots.conf åˆ é™¤å¯¹åº”è¡Œ

# æŸ¥çœ‹çŠ¶æ€
redis-cli HGETALL tts:session_map
python3 tx.py -t
docker exec tts-bot tail -f /tmp/handler.log
```

---

## åŸºç¡€è®¾æ–½

| æœåŠ¡ | ç«¯å£ | è¯´æ˜ |
|------|------|------|
| Redis | 6379 | session map + æ¶ˆæ¯é˜Ÿåˆ— |
| TTS | 15002 | Edge-TTS æ–‡å­—è½¬è¯­éŸ³ |
| STT | 15003 | Google è¯­éŸ³è½¬æ–‡å­— |
| Bot API | 15001 | å›å¤æ¥æ”¶ + å‘é€ |
| nginx | 12345 | Web ç»ˆç«¯è·¯ç”± |
| ttyd | 7680+ | åªè¯» Web ç»ˆç«¯ |
| cloudflared | - | Tunnel (âŒ ç»ä¸èƒ½ kill) |

---

## é¡¹ç›®ç»“æ„

```
tts-bot/
â”œâ”€â”€ tts_bot/                  # æ ¸å¿ƒåŒ…
â”‚   â”œâ”€â”€ bot.py               # Telegram Bot ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ config.py            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ session_map.py       # Redis session æ˜ å°„
â”‚   â”œâ”€â”€ kiro_tmux_backend.py # tmux æ“ä½œå°è£…
â”‚   â””â”€â”€ redis_queue.py       # Redis é˜Ÿåˆ—
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ supervisor.py        # å¤š Bot ç®¡ç†å™¨
â”‚   â”œâ”€â”€ bot_api.py           # HTTP API (FastAPI)
â”‚   â””â”€â”€ kiro_handler.py      # tmux å›å¤æ•è·å™¨
â”œâ”€â”€ bot-router/
â”‚   â””â”€â”€ conf/nginx.conf      # Nginx åŠ¨æ€è·¯ç”±
â”œâ”€â”€ bots.conf                # Bot é…ç½®æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker-start.sh          # å®¹å™¨å…¥å£ (åŒæ¨¡å¼)
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ tx.py                    # tmux æ ‘å½¢æŸ¥çœ‹å·¥å…·
â””â”€â”€ .env
```

---

## å®‰å…¨è§„åˆ™

- âŒ **æ°¸è¿œä¸èƒ½ kill cloudflared**
- âŒ ä¸èƒ½éšæ„ docker-compose down/up
- âœ… ä»£ç ä¿®æ”¹è‡ªåŠ¨é‡è½½ (watchdog, 3ç§’)
- âœ… .env ä¿®æ”¹ â†’ docker restart
- âœ… bots.conf ä¿®æ”¹ â†’ 5s è‡ªåŠ¨ç”Ÿæ•ˆ
- âœ… Dockerfile/docker-compose.yml/requirements.txt ä¿®æ”¹ â†’ éœ€è¦ docker-compose down/up
